pipeline {
    agent { label 'agent1' }

    environment {
        REPO_URL = 'https://github.com/lherbeng/RKE2.git'
        INSTALL_SCRIPT_PATH = 'loadbalancer/install_nginx.sh'
        UNINSTALL_SCRIPT_PATH = 'loadbalancer/uninstall_nginx.sh'
        SSL_SCRIPT_PATH = 'loadbalancer/generate_ssl.sh'
        SSL_LOG_SCRIPT_PATH = 'loadbalancer/generate_ssl_with_logs.sh'
        NGINX_CONFIG = 'loadbalancer/nginx.conf'
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['install', 'uninstall'],
            description: 'Choose whether to install or uninstall LoadBalancer'
        )
        booleanParam(
            name: 'ENABLE_SSL',
            defaultValue: false,
            description: 'Check to enable SSL installation (basic)'
        )
        booleanParam(
            name: 'ENABLE_SSL_WITH_LOGS',
            defaultValue: false,
            description: 'Check to enable SSL installation with logs'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code from GitHub...'
                git url: "${REPO_URL}", branch: 'main'
            }
        }

        stage('Install nginx service') {
            when {
                expression { params.ACTION == 'install' }
            }
            steps {
                echo 'Installing NGINX...'

                sh "chmod +x ${INSTALL_SCRIPT_PATH}"
                sh "./${INSTALL_SCRIPT_PATH}"

                sh """
                    if [ -f /etc/nginx/nginx.conf ]; then
                        sudo mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.orig
                    fi
                """

                echo 'Copying nginx.conf to /etc/nginx/nginx.conf...'
                sh """ 
                    sudo cp ${NGINX_CONFIG} /etc/nginx/nginx.conf
                    sudo nginx -t
                    sudo systemctl restart nginx
                """

                script {
                    if (params.ENABLE_SSL || params.ENABLE_SSL_WITH_LOGS) {
                        def selectedScript = params.ENABLE_SSL_WITH_LOGS ? SSL_LOG_SCRIPT_PATH : SSL_SCRIPT_PATH

                        echo "Preparing to run: ${selectedScript}"

                        // Ensure target directory exists
                        sh "sudo mkdir -p /etc/nginx/ssl"

                        // Make script executable and run it
                        sh """
                            sudo chmod +x ${selectedScript}
                            sudo -E ./${selectedScript}
                        """

                        // Debugging: Show current directory and files
                        sh """
                            echo "Current directory: \$(pwd)"
                            echo "Contents of loadbalancer/:"
                            ls -l loadbalancer/

                            echo "Contents of /etc/nginx/ssl:"
                            sudo ls -l /etc/nginx/ssl || echo "SSL folder not found"

                            echo "Checking for SSL cert and key..."
                            if [ ! -f /etc/nginx/ssl/lgesite.com.crt ] || [ ! -f /etc/nginx/ssl/lgesite.com.key ]; then
                                echo "❌ ERROR: SSL certificate or key is missing!" >&2
                                exit 1
                            fi
                        """

                        echo "Re-testing NGINX configuration after SSL setup..."
                        sh """
                            sudo nginx -t
                            sudo systemctl restart nginx
                        """
                    }
                }
            }
        }

        stage('Uninstall nginx service') {
            when {
                expression { params.ACTION == 'uninstall' }
            }
            steps {
                echo 'Uninstalling NGINX...'
                sh "chmod +x ${UNINSTALL_SCRIPT_PATH}"
                sh "./${UNINSTALL_SCRIPT_PATH}"
            }
        }
    }

    post {
        success {
            script {
                echo "✅ NGINX service ${params.ACTION} completed successfully!"
            }
        }
        failure {
            script {
                echo "❌ NGINX service ${params.ACTION} failed!"
            }
        }
    }
}
